@page
@model Test
@{ Layout = null; }
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotPro Web Client</title>

    <!-- BOTPRO 1 BEGIN -->

    <link rel="stylesheet" href="/chats/chat1/style.css">
    <link rel="stylesheet" href="/chats/chat1/override.css">
    <link rel="stylesheet" href="/css/ProgressBar.css">
    <link rel="stylesheet" href="/css/ChatMobile.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css'>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.rateit/1.1.3/rateit.min.css"
          integrity="sha512-RHUAyHIHPI+fdHxjGhzjxc13sVLP8HR/JOGUOqKDL0Ue29StdDvpwqFjDot6KS0VUUp9MV8PnnzqQqWq1U5WIQ=="
          crossorigin="anonymous" />

        <link rel="stylesheet" href="/Files/DownloadFile/042e23ae-8f92-470d-9e4e-69f0b329cff1" />


    <!-- BOTPRO 1 END -->



</head>

<body>

    <!-- BOTPRO 2 BEGIN -->
    <div class="fabs">
        <div id="chatbot1" class="chat" style="opacity: 0;">
            <div class="chat_header">
                <div class="chat_option">
                    <div class="header_img">
                        <img src="https://botpro.botpropanel.com/img/botpro-icon.jpg" />
                    </div>
                    <div class="title_header">
                        <div class="header" style="color: #ffffff;" onclick="ShowFileInput()">BotPrueba</div>
                        <div class="online_text">Online</div>

                        <div style="text-align: right;">
                            <svg xmlns="http://www.w3.org/2000/svg" id="Clouse" style="position: relative;top: -77px;left: -12px;text-align: right;color: red;" width="16" height="16" fill="currentColor" class="bi bi-x-square-fill" viewBox="0 0 16 16">
                              <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm3.354 4.646L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708z"/>
                            </svg>
                        </div>

                    </div>
                    <div class="online" style="border-color: rgb(255, 255, 255); background: rgb(105, 222, 64);"></div>
                    <span id="chat_fullscreen_loader" class="chat_fullscreen_loader">
                    </span>
                </div>
            </div>

            <div id="chat_fullscreen" class="chat_conversion chat_converse">
                <div id="sendIndicator" style="color: black; text-align: center; margin-top: 50%;">
                    <img src="/img/spin.gif" />
                </div>

                <img id="LOADING" src="/img/105-loader-1 (2).gif" style="position: fixed; bottom: 111px; display:none;" />

            </div>
            <div style="background-color:white" align="center">
                <span style=" font-size: 120%; position: relative; top: -1.5px;">Powered by</span>
                <a target="_blank" href="https://botpro.ai/"><img style="width: 20%; top: 4px; position: relative; margin:0; border:0;border-radius:0;" src="/img/Botpro-logo-268x69.png" /></a>
            </div>
            <div class="fab_field">

                <a id="fab_send" class="fab is-visible" style="width: 40px; height: 40px; opacity: 1; visibility: visible; margin-right: 9px; margin-left: 4px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="black" class="bi bi-cursor" viewBox="0 0 16 16">
                        <path d="M14.082 2.182a.5.5 0 0 1 .103.557L8.528 15.467a.5.5 0 0 1-.917-.007L5.57 10.694.803 8.652a.5.5 0 0 1-.006-.916l12.728-5.657a.5.5 0 0 1 .556.103zM2.25 8.184l3.897 1.67a.5.5 0 0 1 .262.263l1.67 3.897L12.743 3.52 2.25 8.184z"></path>
                    </svg>
                </a>
                <textarea data-emoji-picker="true" id="chatSend" name="chat_message" placeholder="Escribe tu mensaje aquí"
                          class="chat_field chat_message"></textarea>
                <div id="loadingPadre" class="meter" style="display:none;">
                    <span id="loadingHijo" style="width:0%;"><span class="progress"></span></span>
                </div>
            </div>
        </div>
        <div class="text_speech scale-in-right" aria-label="Hola, puedo ayudarte?">Hola! ?  puedo <br> ayudarte?</div>

        <button id="prime" class="burbuja shake-horizontal">
            <i class="prime bi-chat-left-text-fill bi"></i>
        </button>
    </div>
    <!-- BOTPRO 2 END -->
    <!-- BOPRO FILE MODAL BEGIN -->
    <div class="container" style="display:none;">
        <div class="modal"
             style="max-width: 350px; background-color: #fff; position: absolute; top: 50%; left: 50%;
                    transform: translate(-50%, -50%); padding: 2rem; border-radius: 10px; z-index: 3;
                    margin-top: 517px; width: 300px;" hidden="hidden">

            <div class="modal-close">
                <span><i class="bi bi-x-square-fill"></i></span>
            </div>

            <main class="main_full">
                <div class="container" >
                    <div class="panel">
                        <div class="">
                            <img src="/img/Botpro-logo-268x69.png" />
                            <br />
                            <h5>Envío de imagenes y documentos</h5>
                            <br />
                            <input type="file" id="upload_file" name="file">
                            <input id="btnEnviarArchivo" class="bt_subir" type="submit" value="Enviar archivo" style="display:none;">
                            <div class="button_outer">
                                <div class="processing_bar"></div>
                                <div class="success_box"></div>
                            </div>
                        </div>
                    </div>
                    <div class="error_msg"></div>
                    <div class="uploaded_file_view" id="uploaded_view">
                        <span class="file_remove">X</span>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- BOPRO FILE MODAL END -->
    <!-- BOTPRO 3 BEGIN -->

    <!-- MODIFICAR ESTE -->
    <script id="BotReceiveTemplate" type="x-tmpl-mustache">
        <span class="chat_msg_item chat_msg_item_admin">
            <div class="chat_avatar">
                <img src="https://botpro.botpropanel.com/Files/DownloadFile/61b8d02e-49e3-4f68-b01d-d0624686f6ef" />
            </div>{{{msg}}}
             <p style="position:absolute; bottom:-23px;">{{{fecha}}}</p>
        </span>
    </script>

    <!-- MODIFICAR ESTE -->
    <script id="AgentReceiveTemplate" type="x-tmpl-mustache">
        <span class="chat_msg_item chat_msg_item_admin">
            <div class="chat_avatar">
                <img src="" />
            </div>{{{msg}}}
             <p style="position:absolute; bottom:-23px; width: 50px;">{{{fecha}}}</p>
        </span>
    </script>
    <script id="BotReceiveSuggestedTemplate" type="x-tmpl-mustache">
        <span class="chat_msg_item" style="margin-top: -50px;">
            <ul class="tags tags_block" id="">
                {{#menues}}
                <li  onclick="SendMessage('{{.}}', '1')">{{.}}</li>
                {{/menues}}
            </ul>
        </span>
    </script>
    <script id="BotReceiveCardTemplate" type="x-tmpl-mustache">
        <span class="chat_msg_item card" style="text-align: center;>
            <div class='card-header'>
                <h4>{{card.title}}</h4>
            </div>
            <div class="card-body">
                <a class='button button-primary' href='{{card.linkUrl}}' target='_blank'>
                    {{^card.imageUrl}}
                    {{card.linkTitle}}
                    {{/card.imageUrl}}
                    {{#card.imageUrl}}
                    <img class="img-fluid" src="{{.}}" style="max-width: 100%; height: auto;" />
                    {{/card.imageUrl}}
                </a>
            </div>
        </span>
    </script>
    <script id="BotFileCardTemplate" type="x-tmpl-mustache">
        <span class="chat_msg_item chat_msg_item_admin">
            <div class="card-body">
                <a class='button button-primary' href='{{card.linkUrl}}' target='_blank'>Descargar documento</a>
            </div>
        </span>
    </script>
    <script id="BotImageCardTemplate" type="x-tmpl-mustache">
        <span class="chat_msg_item chat_msg_item_admin">
            <div class="card" style="text-align: center;">
                <div class="card-body">
                    <h5 class="card-title">{{card.title}}</h5>
                    <a href="{{card.linkUrl}}" target="_blank" class="card-text">
                        <img class="img-fluid" src="{{card.attachmentUrl}}" style="max-width: 100%; height: auto;" />
                    </a>
                </div>
                <div class="card-footer">
                        <span>{{card.description}}</span>
                </div>
            </div>
            <p style="position:absolute; bottom:-23px; width: 50px;">{{{fecha}}}</p>
        </span>
    </script>

    <script id="BotAudioCardTemplate" type="x-tmpl-mustache">
        <span class="chat_msg_item chat_msg_item_admin">
            <div class="chat_avatar">
                <img src="https://botpro.botpropanel.com/Files/DownloadFile/61b8d02e-49e3-4f68-b01d-d0624686f6ef" />
            </div>
            <audio controls style="width: 262px;">
                <source src="{{card.attachmentUrl}}" type="audio/mp3">
                <source src="{{card.attachmentUrl}}" type="audio/wav">
                <source src="{{card.attachmentUrl}}" type="audio/ogg">
            </audio>

             <p style="position:absolute; bottom:-23px;">{{{fecha}}}</p>
        </span>
    </script>

    <!-- MODIFICAR ESTE -->
    <script id="UserSentTemplate" type="x-tmpl-mustache">
        <span class="chat_msg_item chat_msg_item_user">
            {{msg.message}}
             <p style="position:absolute; bottom:-23px; width: 50px;">{{{fecha}}}</p>
        </span>
    </script>

    <script id="AgentRatingTemplate" type="x-tmpl-mustache">
        <span class="chat_msg_item chat_msg_item_admin">
            <div class="chat_avatar">
                <img src="https://botpro.botpropanel.com/Files/DownloadFile/61b8d02e-49e3-4f68-b01d-d0624686f6ef" />
            </div>{{message}}
            <div class="text-right">
                <div class="rateit">
                </div>
            </div>
        </span>
    </script>
    <!-- BOTPRO 3 END  -->
    <!-- BOTPRO 4 BEGIN -->
    <script>
        
        var userId = '';
        var userName = '';
        var botId = '05aef7d8-d429-4257-8974-103c3d49e7eb';
        var converter;
        
userId = '895b2763-a00f-46b9-bc65-cd47a366be0e';
userName = '';
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
            integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
            crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"
            integrity="sha512-L03kznCrNOfVxOUovR6ESfCz9Gfny7gihUX/huVbQB9zjODtYpxaVtIaAkpetoiyV2eqWbvxMH9fiSv5enX7bw=="
            crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.7/signalr.min.js"
            integrity="sha512-00SWfjArdfIymRqWxQQJQhJLoQQUudL6cV/pJ25Ef6YQhjr+9WeBGrt0Zh0XZaiqF+SEQaoPdUnMW9X+IfZLHA=="
            crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/4.0.1/mustache.min.js"
            integrity="sha512-6AXIWogbKpsHvoZJrJtHpIYES4wP8czSj0zk7ZfwOYS8GWYFNSykwdfapt7yQc4ikZytemBu+QyVObzBHJMwYg=="
            crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.rateit/1.1.3/jquery.rateit.min.js"
            integrity="sha512-f2l5i7zA+mdbjb3QU/8IkEdg6teRTvACGIEalvyY8tt3ThBAI9endvEzPXfSOPCC/3cDSLo4wWy083tduQmGuA=="
            crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/he/1.2.0/he.min.js"
            integrity="sha512-PEsccDx9jqX6Dh4wZDCnWMaIO3gAaU0j46W//sSqQhUQxky6/eHZyeB3NrXD2xsyugAKd4KPiDANkcuoEa2JuA=="
            crossorigin="anonymous"></script>

    <script src="https://unpkg.com/@@js-temporal/polyfill/dist/index.umd.js"></script>
    <script src="/js/Connection.js"></script>
    <script src="/chats/chat1/embedded.js"></script>
    <script src="/js/emojiPicker.js"></script>
    <script src="/js/messageconverter.js"></script>

    <script>
        (() => {
            new EmojiPicker()
        })()


        $(function () {

            if (converter == null)
                converter = new showdown.Converter();


                    if (localStorage.getItem('botpro_userid') != null) {
                        userId = localStorage.getItem('botpro_userid');
                    }

                    var messageUrl = `/Bots/MessagesByUser/05aef7d8-d429-4257-8974-103c3d49e7eb?UserId=${userId}&Channel=1&IsTest=false`;

                    $.getJSON(messageUrl, function(data) {
                            if (data != null)
                            {
                                $.each(data, function(indice, item) {
                                        if (item.text)
                                        {
                                            parseInitialMessage(item);
                                        }
                                });

                                // Scroll
                                var div = document.getElementById('chat_fullscreen');
                                scrollTo(div, div.scrollHeight, 1000);
                            }
                        });
                


        });


        //function ShowFileInput() {
        //    $('#fab_camera_icon_botpro').show();
        //    try {
        //        window.parent.postMessage({
        //            'clicked': true,
        //            'data': 'botProFile'
        //        }, "*");

        //    } catch (e) {
        //        console.log("ERR02-botprofrm-Contactar BotPro" + e);
        //    }
        //}
    </script>

    <!-- emoji libreria -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>

    <script type="text/javascript">
        //---------------------------------------------------------
        // open modal
        //---------------------------------------------------------

        $('.open-modal').on('click', function () {
            // fade in filter layer and modal
            $('.filter, .modal').fadeIn(200);
        });

        //---------------------------------------------------------
        // close modal
        //---------------------------------------------------------

        // close modal by clicking the "close" button or background (outside modal)
        $('.modal-close, .filter').on('click', function () {
            // fade out filter layer and modal
            $('.filter, .modal').fadeOut(200);
        });

        var btnUpload = $("#upload_file"),
            btnOuter = $(".button_outer");

        var botProUploadedFileUrl = "";
        var botProUploadedFileType = "";

        btnUpload.on("change", async function (e) {

            var ext = btnUpload.val().split('.').pop().toLowerCase();
            
            if ($.inArray(ext, ['gif', 'png', 'jpg', 'jpeg', 'pdf', 'xls', 'xlsx', 'txt', 'doc', 'docx', 'mp3', 'ogg', 'mp4', 'wav']) == -1) {
                $(".error_msg").text("No hay archivo");
            }
            else {
                $(".error_msg").text("");

                var imageExtensions = ["jpg", "jpeg", "png", "gif"];
                var docExtensions = ["xls", "xlsx", "doc", "docx", "pdf", "ppt", "pptx", "txt"];
                var audioExtensions = ["ogg", "mp3", "mp4", "wav"];

                if ($.inArray(ext, imageExtensions) > -1)
                    botProUploadedFileType = "image";

                if ($.inArray(ext, audioExtensions) > -1)
                    botProUploadedFileType = "audio";

                if ($.inArray(ext, docExtensions) > -1)
                    botProUploadedFileType = "document";

                btnOuter.addClass("file_uploading");
                setTimeout(function () {
                    btnOuter.addClass("file_uploaded");
                }, 3000);

                var uploadedFile = URL.createObjectURL(e.target.files[0]);
                setTimeout(function () {
                    $("#uploaded_view").append('<img src="' + uploadedFile + '" />').addClass("show");
                }, 3500);

                var data = new FormData();
                data.append('File', e.target.files[0]);
                $('#loadingPadre')[0].style.display = "";
                $('#loadingHijo')[0].style.width = "70%";
                //jQuery.each(, function (i, file) { });

                //debugger;

                //jQuery.ajax({
                //    url: '/Bots/SaveFile',
                //    data: data,
                //    cache: false,
                //    contentType: false,
                //    processData: false,
                //    method: 'POST',
                //    type: 'POST', // For jQuery < 1.9
                //    success: function (data) {
                //        botProUploadedFileUrl = data;
                //    }
                //});

                await fetch('/Bots/SaveFile', { body: data, method: 'POST' }).then(Response => {
                    if (Response.ok) {
                        return Response.text();
                    }
                }).then(text => {
                    botProUploadedFileUrl = text;
                })
                $('#loadingHijo')[0].style.width = "100%";
                try {
                    console.log(`Tipo: ${botProUploadedFileType}, Url: ${botProUploadedFileUrl}`)
                    SendFullMessage(botProUploadedFileType, '0', botProUploadedFileType, botProUploadedFileUrl);
                    $("#uploaded_view").removeClass("show");
                    $('#loadingPadre')[0].style.display = "none";
                } catch (e) {
                    debugger;
                }
            }
        });

        $('#btnEnviarArchivo').on("click", function (e) {

            //alert("enviando archivo de " + botProUploadedFileType + ", subido en la dirección: " + botProUploadedFileUrl);
        });

        $(".file_remove").on("click", function (e) {
            $("#uploaded_view").removeClass("show");
            $("#uploaded_view").find("img").remove();
            btnOuter.removeClass("file_uploading");
            btnOuter.removeClass("file_uploaded");
        });

        function openChat() {
            startChat();
        }
    </script>

    <script>
        (function Mobile(){
            var isMobileDevice = function() {
              let check = false;
              (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
              return check;
            }();

            if(!isMobileDevice){
                var closeButton = document.getElementById("Clouse");
                closeButton.style.display = "none";
            }
    }());
    </script>
    <!-- BOTPRO 4 END -->
    
</body>

</html>
